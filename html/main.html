<html>
<head>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
</head>
<body>
<img src="https://chart.googleapis.com/chart?cht=qr&choe=UTF-8&chs=256x256&chl={{.key}}" alt="{{.key}}"></img>
<div id="main"></div>
<script>
key = "{{.key}}";
token = "{{.token}}";

curl = "curl " + document.location.origin + "/send?key=" + key + "\\&message=yo";

channel = new goog.appengine.Channel(token);
socket = channel.open();
socket.onopen = onOpened;
socket.onmessage = onMessage;
socket.onerror = onError;
socket.onclose = onClose;

function append(str, type) {
  type = type || "P";
  var div = document.getElementById("main");
  var p = document.createElement(type);
  p.appendChild(document.createTextNode(str));
  div.appendChild(p);
}

function onOpened() {
  append(curl, "CODE");
  append("onOpened");
  append("key: " + key);
  append("token: " + token);
}

function onMessage(message) {
  append(message.data);
}

function onError(error) {
  alert("error: " + error);
}

function onClose() {
  append("onClose");
}
</script>
</body>
</html>
